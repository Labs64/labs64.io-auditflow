server:
  port: 8080
  shutdown: graceful

spring:
  application:
    name: labs64.io-auditflow

  # Spring Cloud Stream Configuration
  cloud:
    stream:
      bindings:
        audit-out-0:
          destination: labs64-audit-topic
          binder: rabbit
          content-type: application/json
        audit-in-0:
          destination: labs64-audit-topic
          binder: rabbit
          content-type: application/json
      binders:
        rabbit:
          type: rabbit
      rabbit:
        bindings:
          audit-out-0:
            producer:
              exchangeType: topic
              routing-key-expression: headers['routingKey']
          audit-in-0:
            consumer:
              autoBindDlq: true
              republishToDlq: true
              requeueRejected: false

  # RabbitMQ Configuration
  rabbitmq:
    host: rabbitmq.default.svc.cluster.local
    port: 5672
    username: ${RABBITMQ_USERNAME:}
    password: ${RABBITMQ_PASSWORD:}
    connection-timeout: 10s

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true
      show-details: when-authorized
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true

  # Distributed Tracing
  tracing:
    sampling:
      probability: 1.0

  # Metrics
  metrics:
    tags:
      application: ${spring.application.name}
    export:
      prometheus:
        enabled: true

# Logging Configuration
logging:
  level:
    root: INFO
    io.labs64: DEBUG
    org.springframework.cloud.stream: INFO
    org.springframework.amqp: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

# Transformer Discovery Configuration
transformer:
  discovery:
    mode: local # "local" or "kubernetes"
  local:
    url: "http://localhost:8081"
  service:
    name: auditflow-transformer
    namespace: default
    port: 8081

# Sink Discovery Configuration
sink:
  discovery:
    mode: local # "local" or "kubernetes"
  local:
    url: "http://localhost:8082"
  service:
    name: auditflow-sink
    namespace: default
    port: 8082

# Pipeline Configuration
# Example pipeline configuration (commented out by default):
pipelines: []
#  - name: 'logs'
#    enabled: true
#    # Optional condition to filter events for this pipeline
#    # If not specified, all events will be processed
#    condition:
#      match: 'all'  # 'all' (AND) or 'any' (OR)
#      rules:
#        - field: 'eventType'
#          operator: 'eq'
#          value: 'api.call'
#        - field: 'sourceSystem'
#          operator: 'startsWith'
#          value: 'netlicensing'
#    transformer:
#      name: 'zero'
#    sink:
#      name: 'logging_sink'
#      properties:
#        log-level: "INFO"
#        format: "json"
#  - name: 'security-alerts'
#    enabled: true
#    condition:
#      match: 'any'  # Match if any rule is true
#      rules:
#        - field: 'extra.action_status'
#          operator: 'eq'
#          value: 'FAILURE'
#        - field: 'eventType'
#          operator: 'in'
#          value: 'security.alert,auth.failed,access.denied'
#    transformer:
#      name: 'security_transformer'
#    sink:
#      name: 'slack_sink'
#      properties:
#        webhook-url: "${SLACK_WEBHOOK_URL}"
#  - name: 'loki'
#    enabled: false
#    transformer:
#      name: 'audit_loki'
#    sink:
#      name: 'loki_sink'
#      properties:
#        service-url: "http://loki:3100"
#        service-path: "/loki/api/v1/push"
#        username: "user"
#        password: "password"
#
# Supported condition operators:
#   eq, neq          - equals / not equals
#   contains         - string contains
#   startsWith       - string starts with
#   endsWith         - string ends with
#   in, notIn        - value in/not in comma-separated list
#   exists, notExists - field exists/doesn't exist
#   regex            - regular expression match
#   gt, gte, lt, lte - numeric comparisons
#   eqIgnoreCase     - case-insensitive equals
#
# Field paths support dot notation: 'extra.userId', 'geolocation.countryCode'
# Array access is also supported: 'items[0].name'
